

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>AVS Linkage &#8212; AviSynth+ 3.4 documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../_static/AvsiDoc.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="AssemblerOptimizing" href="AssemblerOptimizing.html" />
    <link rel="prev" title="AMDOptimizationGuide" href="AMDOptimizationGuide.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="AssemblerOptimizing.html" title="AssemblerOptimizing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="AMDOptimizationGuide.html" title="AMDOptimizationGuide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/DocIcon-Large.svg" alt="Logo"/>
            </a></p>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">AVS Linkage</a><ul>
<li><a class="reference internal" href="#removal-of-backed-code">Removal of backed code</a></li>
<li><a class="reference internal" href="#the-implementation-solution">The implementation solution</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="AMDOptimizationGuide.html"
                        title="previous chapter">AMDOptimizationGuide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="AssemblerOptimizing.html"
                        title="next chapter">AssemblerOptimizing</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/avisynthdoc/FilterSDK/AVSLinkage.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="avs-linkage">
<h1>AVS Linkage<a class="headerlink" href="#avs-linkage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="removal-of-backed-code">
<h2>Removal of backed code<a class="headerlink" href="#removal-of-backed-code" title="Permalink to this headline">¶</a></h2>
<p>The plugin api v3 contains baked code (see avisynth.h from v2.58 and
older versions) which is code that is included inline. The result is
all that code is “baked” into all and every plugin instead being called
from avisynth.dll. The problem with baked code is that it cannot be
changed without recompiling the plugin. (If it were just a declaration
only then the active code would be whatever is in the current
avisynth.dll.) This is a problem if the plugin api will be changed
again in the future (and it probably will one day) and this issue is
solved in 2.6.</p>
<p>Starting from 2.6 the version 2.5 plugins are supported directly (with
current baked code; meaning that plugins compiled for 2.5 can be loaded
when using 2.6) and all the baked code from 2.6+ plugins is removed and
the plugins are still source compatible. Note that the baked code is
moved to interface.cpp, where also the structure AVS_Linkage is
defined.</p>
<p>AVS_Linkage is a mechanism to initialize the function table with the
entry points for an alternate server. Server here means something that
loads and executes an avisynth.h api plugin. This is normally
avisynth.dll but Avery Lee has expressed a desire to be able to load
and execute avisynth plugins directly in VirtualDub. Much the same way
Avisynth can currently load VirtualDub plugins today.</p>
</div>
<div class="section" id="the-implementation-solution">
<h2>The implementation solution<a class="headerlink" href="#the-implementation-solution" title="Permalink to this headline">¶</a></h2>
<p>On the user plugin side the entry-point is now called
AvisynthPluginInit3 and it take 2 arguments, an IScriptEnvironment* and
an AVS_Linkage*. The user needs to declare static storage for
AVS_Linkage* AVS_linkage; and in their AvisynthPluginInit3 code save
the supplied 2nd value to the AVS_linkage variable. The rest of the
code should be the same as for 2.5 plugins, i.e. env-&gt;AddFunction, etc.</p>
<p>In avisynth.h the type AVS_Linkage structure is declared and macros
emit stub baked code that calls the appropriate code in the server via
the AVS_Linkage function pointers. The stub code checks to make sure
AVS_linkage is not Null and the offset of the function pointer is
within the current size of the structure. If okay the function is
called otherwise it evaluates as 0. Within the Avisynth.dll project
these macros resolve to a simple “;” so no stub code is emitted just
declarations occur, this is triggered by the definition of the reserved
symbol AVISYNTH_CORE.</p>
<p>In interface.cpp the real code is defined and the instance of the
AVS_Linkage structure is declared and initialised. In plugins.cpp the
address of this is passed to the users AvisynthPluginInit3 code along
with the ScriptEnvironment address. A minor hurdle was that you may not
take the address of constructor or destructor routines in C++ so I to
move forward I just nested the appropriate code for these down one
method and used the address of the nested method. I unimaginatively
called these CONSTRUCTORn() and DESTRUCTOR() [edit: shouldn’t this be
DESTRUCTORn()???].</p>
<p>In your plugin source file the changes are trivial. Declare the storage
for AVS_linkage, rename the .dll entrypoint from AvisynthPluginInit2 to
AvisynthPluginInit3 and add the extra AVS_Linkage* argument.</p>
<p><a class="reference external" href="http://forum.doom9.org/showthread.php?t=101730">discussion on Doom9</a> (in
particular
<a class="reference external" href="http://forum.doom9.org/showthread.php?p=1567792#post1567792">this post</a> and
<a class="reference external" href="http://forum.doom9.org/showthread.php?p=1631250#post1631250">this post</a>).</p>
<hr class="docutils" />
<p>Back to <a class="reference internal" href="FilterSDK.html"><span class="doc">AviSynth FilterSDK</span></a></p>
<p>$Date: 2014/10/27 22:04:54 $</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="AssemblerOptimizing.html" title="AssemblerOptimizing"
             >next</a> |</li>
        <li class="right" >
          <a href="AMDOptimizationGuide.html" title="AMDOptimizationGuide"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2000-2019, AviSynth and AviSynth+ contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>