

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>BensAviSynthDocs &#8212; AviSynth+ 3.4 documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../_static/AvsiDoc.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="C API" href="C_api.html" />
    <link rel="prev" title="AviSynthTwoFiveSDK" href="AviSynthTwoFiveSDK.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="C_api.html" title="C API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="AviSynthTwoFiveSDK.html" title="AviSynthTwoFiveSDK"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/DocIcon-Large.svg" alt="Logo"/>
            </a></p>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">BensAviSynthDocs</a><ul>
<li><a class="reference internal" href="#writing-avisynth-plugins">Writing Avisynth plugins</a><ul>
<li><a class="reference internal" href="#an-example">An example</a></li>
<li><a class="reference internal" href="#how-it-works">How it works</a></li>
<li><a class="reference internal" href="#variations">Variations</a><ul>
<li><a class="reference internal" href="#an-in-place-filter">An in-place filter</a></li>
<li><a class="reference internal" href="#a-filter-that-changes-the-frame-size">A filter that changes the frame size</a></li>
<li><a class="reference internal" href="#a-filter-which-processes-audio">A filter which processes audio</a></li>
<li><a class="reference internal" href="#a-filter-which-rearranges-frames">A filter which rearranges frames</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-useful-methods-in-iscriptenvironment">Other useful methods in IScriptEnvironment</a><ul>
<li><a class="reference internal" href="#notes-to-ben-s-docs">Notes to Ben’s docs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="AviSynthTwoFiveSDK.html"
                        title="previous chapter">AviSynthTwoFiveSDK</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="C_api.html"
                        title="next chapter">C API</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/avisynthdoc/FilterSDK/BensAviSynthDocs.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="bensavisynthdocs">
<h1><a class="toc-backref" href="#id1">BensAviSynthDocs</a><a class="headerlink" href="#bensavisynthdocs" title="Permalink to this headline">¶</a></h1>
<p>This is a text of the original documentation written for AviSynth 1.0 by Ben
Rudiak-Gould - copied from <a class="reference external" href="http://math.berkeley.edu/~benrg/avisynth-extensions.html">http://math.berkeley.edu/~benrg/avisynth-extensions.html</a>.
Now (November 2006) it is available online at the <a class="reference external" href="http://www.neuron2.net/www.math.berkeley.edu/benrg/avisynth-extensions.html">mirror.</a></p>
<div class="toctree-wrapper compound">
</div>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#bensavisynthdocs" id="id1">BensAviSynthDocs</a><ul>
<li><a class="reference internal" href="#writing-avisynth-plugins" id="id2">Writing Avisynth plugins</a><ul>
<li><a class="reference internal" href="#an-example" id="id3">An example</a></li>
<li><a class="reference internal" href="#how-it-works" id="id4">How it works</a></li>
<li><a class="reference internal" href="#variations" id="id5">Variations</a><ul>
<li><a class="reference internal" href="#an-in-place-filter" id="id6">An in-place filter</a></li>
<li><a class="reference internal" href="#a-filter-that-changes-the-frame-size" id="id7">A filter that changes the frame size</a></li>
<li><a class="reference internal" href="#a-filter-which-processes-audio" id="id8">A filter which processes audio</a></li>
<li><a class="reference internal" href="#a-filter-which-rearranges-frames" id="id9">A filter which rearranges frames</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-useful-methods-in-iscriptenvironment" id="id10">Other useful methods in IScriptEnvironment</a><ul>
<li><a class="reference internal" href="#notes-to-ben-s-docs" id="id11">Notes to Ben’s docs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="writing-avisynth-plugins">
<h2><a class="toc-backref" href="#id2">Writing Avisynth plugins</a><a class="headerlink" href="#writing-avisynth-plugins" title="Permalink to this headline">¶</a></h2>
<div class="section" id="an-example">
<h3><a class="toc-backref" href="#id3">An example</a><a class="headerlink" href="#an-example" title="Permalink to this headline">¶</a></h3>
<p>I’ll start off with a complete, working Avisynth plugin. It’s called
“Invert,” and it produces a photo-negative of the input clip.</p>
<p><strong>Here’s Invert.cpp</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;avisynth.h&quot;</span>


<span class="k">class</span> <span class="nc">Invert</span> <span class="p">:</span> <span class="n">public</span> <span class="n">GenericVideoFilter</span> <span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
    <span class="n">Invert</span><span class="p">(</span><span class="n">PClip</span> <span class="n">_child</span><span class="p">)</span> <span class="p">:</span> <span class="n">GenericVideoFilter</span><span class="p">(</span><span class="n">_child</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">PVideoFrame</span> <span class="n">__stdcall</span> <span class="n">GetFrame</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">IScriptEnvironment</span><span class="o">*</span>
    <span class="n">env</span><span class="p">);</span>
<span class="p">};</span>


<span class="n">PVideoFrame</span> <span class="n">__stdcall</span> <span class="n">Invert</span><span class="p">::</span><span class="n">GetFrame</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">IScriptEnvironment</span><span class="o">*</span>
<span class="n">env</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">PVideoFrame</span> <span class="n">src</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">GetFrame</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>
    <span class="n">PVideoFrame</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewVideoFrame</span><span class="p">(</span><span class="n">vi</span><span class="p">);</span>

    <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">srcp</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">GetReadPtr</span><span class="p">();</span>
    <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">dstp</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetWritePtr</span><span class="p">();</span>

    <span class="n">const</span> <span class="nb">int</span> <span class="n">src_pitch</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">GetPitch</span><span class="p">();</span>
    <span class="n">const</span> <span class="nb">int</span> <span class="n">dst_pitch</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetPitch</span><span class="p">();</span>
    <span class="n">const</span> <span class="nb">int</span> <span class="n">row_size</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetRowSize</span><span class="p">();</span>
    <span class="n">const</span> <span class="nb">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetHeight</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">row_size</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
            <span class="n">dstp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">^</span> <span class="mi">255</span><span class="p">;</span>
        <span class="n">srcp</span> <span class="o">+=</span> <span class="n">src_pitch</span><span class="p">;</span>
        <span class="n">dstp</span> <span class="o">+=</span> <span class="n">dst_pitch</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">AVSValue</span> <span class="n">__cdecl</span> <span class="n">Create_Invert</span><span class="p">(</span><span class="n">AVSValue</span> <span class="n">args</span><span class="p">,</span> <span class="n">void</span><span class="o">*</span> <span class="n">user_data</span><span class="p">,</span>
<span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">new</span> <span class="n">Invert</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AsClip</span><span class="p">());</span>
<span class="p">}</span>


<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">__stdcall</span>
<span class="n">AvisynthPluginInit</span><span class="p">(</span><span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">env</span><span class="o">-&gt;</span><span class="n">AddFunction</span><span class="p">(</span><span class="s2">&quot;Invert&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">Create_Invert</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;`Invert&#39; sample plugin&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile this file into a DLL named Invert.dll. Now create an
Avisynth script which looks something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LoadPlugin</span><span class="p">(</span><span class="s2">&quot;d:\path\Invert.dll&quot;</span><span class="p">)</span>
<span class="n">clip</span> <span class="o">=</span> <span class="n">AVISource</span><span class="p">(</span><span class="s2">&quot;d:\path2</span><span class="se">\v</span><span class="s2">ideo.avi&quot;</span><span class="p">)</span>
<span class="k">return</span> <span class="n">clip</span><span class="o">.</span><span class="n">Invert</span><span class="p">()</span>
</pre></div>
</div>
<p>If all is well, you should see a photo negative of your video clip
when you open this script.</p>
</div>
<div class="section" id="how-it-works">
<h3><a class="toc-backref" href="#id4">How it works</a><a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h3>
<p>Here’s a line-by-line breakdown of Invert.cpp.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;avisynth.h&quot;</span>
</pre></div>
</div>
<p>This header declares all the classes and miscellaneous constants that you
might need when writing a plugin. All external plugins should #include it.</p>
<p>External plugins do not link with <code class="docutils literal notranslate"><span class="pre">avisynth.dll</span></code>, so they can’t directly
access functions that are defined in the main Avisynth source code.
Therefore, every important function in <code class="docutils literal notranslate"><span class="pre">avisynth.h</span></code> is either defined
inline or declared as <code class="docutils literal notranslate"><span class="pre">virtual</span></code>. The virtual functions act as callbacks for
external DLLs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Invert</span> <span class="p">:</span> <span class="n">public</span> <span class="n">GenericVideoFilter</span> <span class="p">{</span>
</pre></div>
</div>
<p>An Avisynth filter is simply a C++ class implementing the <code class="docutils literal notranslate"><span class="pre">IClip</span></code>
interface. <code class="docutils literal notranslate"><span class="pre">IClip</span></code> has four pure virtual methods: <code class="docutils literal notranslate"><span class="pre">GetVideoInfo</span></code>,
<code class="docutils literal notranslate"><span class="pre">GetFrame</span></code>, <code class="docutils literal notranslate"><span class="pre">GetParity</span></code>, and <code class="docutils literal notranslate"><span class="pre">GetAudio</span></code>.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">GenericVideoFilter</span></code> is a simple do-nothing filter defined in
<code class="docutils literal notranslate"><span class="pre">avisynth.h</span></code>. It derives from <code class="docutils literal notranslate"><span class="pre">IClip</span></code> and implements all four methods.
Most filters can inherit from <code class="docutils literal notranslate"><span class="pre">GenericVideoFilter</span></code> rather than directly
from <code class="docutils literal notranslate"><span class="pre">IClip</span></code>; this saves you from having to implement methods that you
don’t care about, like <code class="docutils literal notranslate"><span class="pre">GetAudio</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Invert</span><span class="p">(</span><span class="n">PClip</span> <span class="n">_child</span><span class="p">)</span> <span class="p">:</span> <span class="n">GenericVideoFilter</span><span class="p">(</span><span class="n">_child</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">PClip</span></code> is a “smart pointer” to an <code class="docutils literal notranslate"><span class="pre">IClip</span></code>. It maintains a reference
count on the IClip object and automagically deletes it when the last PClip
referencing it goes away. For obvious reasons, you should always use PClip
rather than IClip* to refer to clips.</p>
<p>Like a genuine pointer, a <code class="docutils literal notranslate"><span class="pre">PClip</span></code> is only four bytes long, so you can pass
it around by value. Also like a pointer, a <code class="docutils literal notranslate"><span class="pre">PClip</span></code> can be assigned a null
value (0), which is often useful as a sentinel. Unlike a pointer, <code class="docutils literal notranslate"><span class="pre">PClip</span></code>
is initialized to 0 by default.</p>
<p>You’ll need to make sure your class doesn’t contain any circular <code class="docutils literal notranslate"><span class="pre">PClip</span></code>
references, or any <code class="docutils literal notranslate"><span class="pre">PClip``s</span> <span class="pre">sitting</span> <span class="pre">in</span> <span class="pre">dynamically</span> <span class="pre">allocated</span> <span class="pre">memory</span> <span class="pre">that</span>
<span class="pre">you</span> <span class="pre">forget</span> <span class="pre">to</span> <span class="pre">``delete</span></code>. Other than that, you don’t have to worry about the
reference-counting machinery.</p>
<p>Avisynth filters have a standardized output channel via <code class="docutils literal notranslate"><span class="pre">IClip</span></code>, but
(unlike VirtualDub filters) no standardized input channel. Each filter is
responsible for obtaining its own source material – usually (as in this
case) from another clip, but sometimes from several different clips, or from
a file.</p>
<p><code class="docutils literal notranslate"><span class="pre">GenericVideoFilter</span></code> has a single constructor taking a single clip, which
it then simply passes through to its output. We will override the
<code class="docutils literal notranslate"><span class="pre">GetFrame</span></code> method to do something more useful, while leaving the other
three methods as-is to pass through aspects of the clip that we don’t need to
change.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PVideoFrame</span> <span class="n">Invert</span><span class="p">::</span><span class="n">GetFrame</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<p>This method is called to make our filter produce frame <code class="docutils literal notranslate"><span class="pre">n</span></code> of its output.
The second argument, <code class="docutils literal notranslate"><span class="pre">env</span></code>, is for our purposes simply a callback suite. It
is actually implemented in Avisynth by a class called <code class="docutils literal notranslate"><span class="pre">ScriptEnvironment</span></code>.
One instance of this class is created for each opened AVS script, so there
may sometimes be several instances active at once. It is important that the
callback functions be called through the proper instance. A particular
instance of your class will only be used in one ScriptEnvironment, but
different instances might be used in different ScriptEnvironments.</p>
<p>This method returns a PVideoFrame, which is a smart pointer like PClip.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PVideoFrame</span> <span class="n">src</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">GetFrame</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>
</pre></div>
</div>
<p>“<code class="docutils literal notranslate"><span class="pre">child</span></code>” is a protected member of <code class="docutils literal notranslate"><span class="pre">GenericVideoFilter</span></code>, of type PClip.
It contains the clip that was passed to the constructor. For our filter to
produce frame <code class="docutils literal notranslate"><span class="pre">n</span></code> we need the corresponding frame of the input. If you need
a different frame from the input, all you have to do is pass a different
frame number to <code class="docutils literal notranslate"><span class="pre">child-&gt;GetFrame</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">GetFrame</span></code> calls are usually intercepted by Avisynth’s internal caching
code, so the frame request may never actually reach the child filter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PVideoFrame</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewVideoFrame</span><span class="p">(</span><span class="n">vi</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">NewVideoFrame</span></code> callback allocates space for a video frame of the
supplied size. (In this case it will hold our filter’s output.) The frame
buffer is uninitialized raw memory (except that in the debug build it gets
filled with the repeating byte pattern 0A 11 0C A7 ED, which is easy to
recognize because it looks like “ALLOCATED”).</p>
<p>“<code class="docutils literal notranslate"><span class="pre">vi</span></code>” is another protected member of <code class="docutils literal notranslate"><span class="pre">GenericVideoFilter</span></code> (the only
other member, actually). It is a struct of type <code class="docutils literal notranslate"><span class="pre">VideoInfo</span></code>, which contains
information about the clip (like frame size, frame rate, pixel format, audio
sample rate, etc.). <code class="docutils literal notranslate"><span class="pre">NewVideoFrame</span></code> uses the information in this struct to
return a frame buffer of the appropriate size.</p>
<p>Frame buffers are reused once all the PVideoFrame references to them go away.
So usually <code class="docutils literal notranslate"><span class="pre">NewVideoFrame</span></code> won’t actually need to allocate any memory from
the heap.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">srcp</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">GetReadPtr</span><span class="p">();</span>
<span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">dstp</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetWritePtr</span><span class="p">();</span>
</pre></div>
</div>
<p>All frame buffers are readable, but not all are writable.</p>
<p>The rule about writability is this: <em>A buffer is writable if and only if
there is exactly one PVideoFrame pointing to it.</em> In other words, you can
only write to a buffer if no one else might be reading it. This rule
guarantees that as long as you hold on to a PVideoFrame and don’t write to it
yourself, that frame will remain unchanged. The only drawback is that you
can’t have two PVideoFrames pointing to a writable buffer. This can sometimes
be an inconvenience, as I’ll explain later.</p>
<p>Any buffer you get from <code class="docutils literal notranslate"><span class="pre">NewVideoFrame</span></code> is guaranteed to be writable (as
long as you only assign it to one PVideoFrame!). Our filter’s <code class="docutils literal notranslate"><span class="pre">dst</span></code> came
from NewVideoFrame, so we can safely call dst-&gt;GetWritePtr(). However, frames
you get from other clips via <code class="docutils literal notranslate"><span class="pre">GetFrame</span></code> may not be writable, in which case
GetWritePtr() will return a null pointer.</p>
<p>There is an <code class="docutils literal notranslate"><span class="pre">IsWritable()</span></code> method which you can call to find out if a
buffer is writable or not, and there’s a <code class="docutils literal notranslate"><span class="pre">MakeWritable</span></code> callback (described
below) to ensure that it is.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="nb">int</span> <span class="n">src_pitch</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">GetPitch</span><span class="p">();</span>
<span class="n">const</span> <span class="nb">int</span> <span class="n">dst_pitch</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetPitch</span><span class="p">();</span>
</pre></div>
</div>
<p>Just as in VirtualDub, the “pitch” of a frame buffer is the offset (in bytes)
from the beginning of one scan line to the beginning of the next. The source
and destination buffers won’t necessarily have the same pitch.</p>
<p>Buffers created by <code class="docutils literal notranslate"><span class="pre">NewVideoFrame</span></code> are always quadword (8-byte) aligned and
always have a pitch that is a multiple of 8.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="nb">int</span> <span class="n">row_size</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetRowSize</span><span class="p">();</span>
</pre></div>
</div>
<p>The row size is the length of each row in bytes (not pixels). It’s usually
equal to the pitch or slightly less, but it may be significantly less if the
frame in question has been through <code class="docutils literal notranslate"><span class="pre">Crop</span></code>.</p>
<p>Since our source and destination frames have the same width and pixel format,
they will always have the same row size. Thus I only need one row_size
variable, and I could just as well have called src-&gt;GetRowSize().</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="nb">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetHeight</span><span class="p">();</span>
</pre></div>
</div>
<p>The height is the height. (In pixels.) Again, for our filter this is the same
for the source and the destination.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">row_size</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
        <span class="n">dstp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">^</span> <span class="mi">255</span><span class="p">;</span>
    <span class="n">srcp</span> <span class="o">+=</span> <span class="n">src_pitch</span><span class="p">;</span>
    <span class="n">dstp</span> <span class="o">+=</span> <span class="n">dst_pitch</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is the code that does the actual work. The “srcp += src_pitch; dstp +=
dst_pitch;” idiom is a useful way of dealing with potentially differing
pitches without too much grief.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">GetFrame</span></code> returns the newly-created frame. Our own references to this
frame and to the source frame will go away with the <code class="docutils literal notranslate"><span class="pre">src</span></code> and <code class="docutils literal notranslate"><span class="pre">dst</span></code>
variables. Our caller will become sole owner of the destination frame (which
therefore will still be writable), and the source frame will be retained in
the cache and eventually recycled. All through the magic of C++ classes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AVSValue</span> <span class="n">__cdecl</span> <span class="n">Create_Invert</span><span class="p">(</span><span class="n">AVSValue</span> <span class="n">args</span><span class="p">,</span> <span class="n">void</span><span class="o">*</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<p>In order to use our new filter, we need a scripting-language function which
creates an instance of it. This is that function.</p>
<p>Script functions written in C++ take three arguments. <code class="docutils literal notranslate"><span class="pre">args</span></code> contains all
the arguments passed to the function by the script. <code class="docutils literal notranslate"><span class="pre">user_data</span></code> contains
the void pointer which you passed to <code class="docutils literal notranslate"><span class="pre">AddFunction</span></code> (see below). Usually you
won’t need this. <code class="docutils literal notranslate"><span class="pre">env</span></code> contains the same IScriptEnvironment pointer that
will later be passed to <code class="docutils literal notranslate"><span class="pre">GetFrame</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">AVSValue</span></code> is a variant type which can hold any one of the following: a
boolean value (true/false); an integer; a floating-point number; a string; a
video clip (PClip); an array of AVSValues; or nothing (“undefined”). You can
test which one it is with the methods <code class="docutils literal notranslate"><span class="pre">IsBool()</span></code>, <code class="docutils literal notranslate"><span class="pre">IsInt()</span></code>,
<code class="docutils literal notranslate"><span class="pre">IsFloat()</span></code>, <code class="docutils literal notranslate"><span class="pre">IsString()</span></code>, <code class="docutils literal notranslate"><span class="pre">IsClip()</span></code>, <code class="docutils literal notranslate"><span class="pre">IsArray()</span></code>, and <code class="docutils literal notranslate"><span class="pre">Defined()</span></code>
(which returns true if the AVSValue is not “undefined”). You can get the
value with <code class="docutils literal notranslate"><span class="pre">AsBool()</span></code>, <code class="docutils literal notranslate"><span class="pre">AsInt()</span></code>, etc. For arrays, you can use the
<code class="docutils literal notranslate"><span class="pre">ArraySize()</span></code> method to get the number of elements, and <code class="docutils literal notranslate"><span class="pre">[]</span></code> indexing to
get the elements themselves. For convenience, <code class="docutils literal notranslate"><span class="pre">IsFloat()</span></code> and <code class="docutils literal notranslate"><span class="pre">AsFloat()</span></code>
will work with integers also. But boolean values are not treated as numeric
(unlike C).</p>
<p>The name “Create_Invert” is arbitrary. This function will actually be known
as “Invert” in scripts, because that’s the name we pass to <code class="docutils literal notranslate"><span class="pre">AddFunction</span></code>
below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">new</span> <span class="n">Invert</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AsClip</span><span class="p">());</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">args</span></code> argument passed to a script function will always be an array.
The return value should be any one of the other types (never an array).</p>
<p>The types of the values in the <code class="docutils literal notranslate"><span class="pre">args</span></code> array are guaranteed to match one of
the function signatures that you pass to <code class="docutils literal notranslate"><span class="pre">AddFunction</span></code>, just as in
VirtualDub. Therefore, there’s no need to worry about <code class="docutils literal notranslate"><span class="pre">IsClip</span></code> here.</p>
<p><code class="docutils literal notranslate"><span class="pre">Create_Invert</span></code> simply creates and returns a filter instance; it is
automatically converted to an AVSValue via the constructor
<code class="docutils literal notranslate"><span class="pre">AVSValue(IClip*)</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">__stdcall</span> <span class="n">AvisynthPluginInit</span><span class="p">(</span><span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<p>This is the only function which gets exported from the DLL. It is called by
the script function <code class="docutils literal notranslate"><span class="pre">LoadPlugin</span></code> the first time this plugin in loaded <em>in a
particular script</em>. If several scripts are open at once and more than one of
them loads this plugin, <code class="docutils literal notranslate"><span class="pre">AvisynthPluginInit</span></code> may be called more than once
with different IScriptEnvironments. Therefore:</p>
<ul class="simple">
<li>You should not save the <code class="docutils literal notranslate"><span class="pre">env</span></code> parameter in a global variable.</li>
<li>If you need to initialize any static data, you should do it in
<code class="docutils literal notranslate"><span class="pre">DLLMain</span></code>, not in this function.</li>
</ul>
<p>The main purpose of the <code class="docutils literal notranslate"><span class="pre">AvisynthPluginInit</span></code> function is to call
<code class="docutils literal notranslate"><span class="pre">env-&gt;AddFunction</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">-&gt;</span><span class="n">AddFunction</span><span class="p">(</span><span class="s2">&quot;Invert&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">Create_Invert</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>As promised, we now call <code class="docutils literal notranslate"><span class="pre">AddFunction</span></code> to let Avisynth know of the
existence of our filter. This function takes four arguments: the name of the
new script function; the parameter-type string; the C++ function implementing
the script function; and the <code class="docutils literal notranslate"><span class="pre">user_data</span></code> cookie.</p>
<p>The parameter-type string is similar to the corresponding entity in
VirtualDub, except that:</p>
<ul class="simple">
<li>No return type is given. Function return values are not type-checked;
you can return anything you like.</li>
<li>There are more types: along with ‘i’nt and ‘s’tring you can specify
‘b’ool, ‘f’loat, and ‘c’lip.</li>
<li>You can follow any type with ‘*’ or ‘+’ to indicate “zero or more” or
“one or more” respectively. In this case all the matching arguments will
be gathered into a sub-array. For example, if your type string is “is+f”,
then the integer argument will be args[0], the string arguments will be
args[1][0], args[1][1], etc. (and there will be args[1].ArraySize() of
them), and the float argument will be args[2].</li>
<li>‘.’ matches a <em>single</em> argument of any type. To match multiple
arguments of any type, use “.*” or “.+”.</li>
<li>You can have named arguments, by specifying the name in [brackets]
before the type. Named arguments are also optional arguments; if the user
omits them, they will be of the undefined type instead of the type you
specify. For convenience, <code class="docutils literal notranslate"><span class="pre">AVSValue</span></code> offers a set of <code class="docutils literal notranslate"><span class="pre">As...()</span></code>
functions which take default values. See <code class="docutils literal notranslate"><span class="pre">avisynth.h</span></code>.</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="s2">&quot;`Invert&#39; sample plugin&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>The return value of <code class="docutils literal notranslate"><span class="pre">AvisynthPluginInit</span></code> is a string which can contain any
message you like, such as a notice identifying the version and author of the
plugin. This string becomes the return value of <code class="docutils literal notranslate"><span class="pre">LoadPlugin</span></code>, and will
almost always be ignored. You can also just return 0 if you prefer.</p>
</div>
<div class="section" id="variations">
<h3><a class="toc-backref" href="#id5">Variations</a><a class="headerlink" href="#variations" title="Permalink to this headline">¶</a></h3>
<div class="section" id="an-in-place-filter">
<h4><a class="toc-backref" href="#id6">An in-place filter</a><a class="headerlink" href="#an-in-place-filter" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Invert</span></code> filter could easily do its work in a single buffer, rather
than copying from one buffer to another. Here’s a new implementation of
<code class="docutils literal notranslate"><span class="pre">GetFrame</span></code> that does this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PVideoFrame</span> <span class="n">Invert</span><span class="p">::</span><span class="n">GetFrame</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">PVideoFrame</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">GetFrame</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>

    <span class="n">env</span><span class="o">-&gt;</span><span class="n">MakeWritable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>

    <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">GetWritePtr</span><span class="p">();</span>
    <span class="n">const</span> <span class="nb">int</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">GetPitch</span><span class="p">();</span>
    <span class="n">const</span> <span class="nb">int</span> <span class="n">row_size</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">GetRowSize</span><span class="p">();</span>
    <span class="n">const</span> <span class="nb">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">GetHeight</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">row_size</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
            <span class="n">p</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">255</span><span class="p">;</span>
        <span class="n">p</span> <span class="o">+=</span> <span class="n">pitch</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">frame</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The key difference between this version of the function and the original
version is the presence of the <code class="docutils literal notranslate"><span class="pre">MakeWritable</span></code> callback. This is necessary
because this time “we don’t know where that frame’s been.” Someone else in
the filter chain may be holding a reference to it, in which case we won’t be
allowed to write to it.</p>
<p><code class="docutils literal notranslate"><span class="pre">MakeWritable</span></code> is a simple solution to this problem. It is implemented as
follows (in avisynth.cpp):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">ScriptEnvironment</span><span class="p">::</span><span class="n">MakeWritable</span><span class="p">(</span><span class="n">PVideoFrame</span><span class="o">*</span> <span class="n">pvf</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">const</span> <span class="n">PVideoFrame</span><span class="o">&amp;</span> <span class="n">vf</span> <span class="o">=</span> <span class="o">*</span><span class="n">pvf</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">frame</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">writable</span><span class="p">,</span> <span class="n">do</span> <span class="n">nothing</span><span class="o">.</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">IsWritable</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">//</span> <span class="n">Otherwise</span><span class="p">,</span> <span class="n">allocate</span> <span class="n">a</span> <span class="n">new</span> <span class="n">frame</span> <span class="p">(</span><span class="n">using</span> <span class="n">NewVideoFrame</span><span class="p">)</span> <span class="ow">and</span>
  <span class="o">//</span> <span class="n">copy</span> <span class="n">the</span> <span class="n">data</span> <span class="n">into</span> <span class="n">it</span><span class="o">.</span>  <span class="n">Then</span> <span class="n">modify</span> <span class="n">the</span> <span class="n">passed</span> <span class="n">PVideoFrame</span>
  <span class="o">//</span> <span class="n">to</span> <span class="n">point</span> <span class="n">to</span> <span class="n">the</span> <span class="n">new</span> <span class="n">buffer</span><span class="o">.</span>

  <span class="k">else</span> <span class="p">{</span>
    <span class="n">const</span> <span class="nb">int</span> <span class="n">row_size</span> <span class="o">=</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">GetRowSize</span><span class="p">();</span>
    <span class="n">const</span> <span class="nb">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">GetHeight</span><span class="p">();</span>
    <span class="n">PVideoFrame</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">NewVideoFrame</span><span class="p">(</span><span class="n">row_size</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
    <span class="n">BitBlt</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetWritePtr</span><span class="p">(),</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">GetPitch</span><span class="p">(),</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">GetReadPtr</span><span class="p">(),</span>
    <span class="n">vf</span><span class="o">-&gt;</span><span class="n">GetPitch</span><span class="p">(),</span> <span class="n">row_size</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
    <span class="o">*</span><span class="n">pvf</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="a-filter-that-changes-the-frame-size">
<h4><a class="toc-backref" href="#id7">A filter that changes the frame size</a><a class="headerlink" href="#a-filter-that-changes-the-frame-size" title="Permalink to this headline">¶</a></h4>
<p>In order to effect a change in frame size, two things must happen:</p>
<ul class="simple">
<li>your <code class="docutils literal notranslate"><span class="pre">GetVideoInfo</span></code> method must return a <code class="docutils literal notranslate"><span class="pre">VideoInfo</span></code> struct with
the appropriate size, and</li>
<li>your <code class="docutils literal notranslate"><span class="pre">GetFrame</span></code> method must return video frames of the appropriate
size.</li>
</ul>
<p>If you derive your filter class from <code class="docutils literal notranslate"><span class="pre">GenericVideoFilter</span></code>, then a
convenient way to achieve both of these things is to assign the new values to
<code class="docutils literal notranslate"><span class="pre">vi.width</span></code> and <code class="docutils literal notranslate"><span class="pre">vi.height</span></code> in your class constructor. This way you won’t
have to override <code class="docutils literal notranslate"><span class="pre">GetVideoInfo</span></code>, since <code class="docutils literal notranslate"><span class="pre">GenericVideoFilter</span></code>’s
implementation just returns <code class="docutils literal notranslate"><span class="pre">vi</span></code>. And if you allocate your output frames
using <code class="docutils literal notranslate"><span class="pre">env-&gt;NewVideoFrame(vi)</span></code>, then they will be of the appropriate size
as well.</p>
<p>For an example of a simple filter which does this, see <code class="docutils literal notranslate"><span class="pre">Crop</span></code> or
<code class="docutils literal notranslate"><span class="pre">StackVertical</span></code>.</p>
</div>
<div class="section" id="a-filter-which-processes-audio">
<h4><a class="toc-backref" href="#id8">A filter which processes audio</a><a class="headerlink" href="#a-filter-which-processes-audio" title="Permalink to this headline">¶</a></h4>
<p>Audio processing is handled through the <code class="docutils literal notranslate"><span class="pre">GetAudio</span></code> method, which has the
following prototype:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">GetAudio</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">int</span> <span class="n">start</span><span class="p">,</span> <span class="nb">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">);</span>
</pre></div>
</div>
<p>You must fill in the <code class="docutils literal notranslate"><span class="pre">buf``fer</span> <span class="pre">with</span> <span class="pre">``count</span></code> samples beginning with sample
number <code class="docutils literal notranslate"><span class="pre">start</span></code>. A sample may vary from one to four bytes, depending on
whether the audio is 8- or 16-bit and mono or stereo. The flags <code class="docutils literal notranslate"><span class="pre">vi.stereo</span></code>
and <code class="docutils literal notranslate"><span class="pre">vi.sixteen_bit</span></code> will tell you this.</p>
<p>If you cannot do your audio processing in-place, you must allocate your own
buffer for the source audio using <code class="docutils literal notranslate"><span class="pre">new</span></code> or <code class="docutils literal notranslate"><span class="pre">malloc</span></code>.</p>
</div>
<div class="section" id="a-filter-which-rearranges-frames">
<h4><a class="toc-backref" href="#id9">A filter which rearranges frames</a><a class="headerlink" href="#a-filter-which-rearranges-frames" title="Permalink to this headline">¶</a></h4>
<p>Many of the built-in filters do nothing more than rearrange video frames (for
example <code class="docutils literal notranslate"><span class="pre">Trim</span></code>, <code class="docutils literal notranslate"><span class="pre">Splice</span></code>, <code class="docutils literal notranslate"><span class="pre">SelectEvery</span></code>, <code class="docutils literal notranslate"><span class="pre">Interleave</span></code>, <code class="docutils literal notranslate"><span class="pre">Reverse</span></code>,
and <code class="docutils literal notranslate"><span class="pre">ChangeFPS</span></code>). If you want to do this, you can write a <code class="docutils literal notranslate"><span class="pre">GetFrame</span></code>
method like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PVideoFrame</span> <span class="n">GetFrame</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">GetFrame</span><span class="p">(</span><span class="n">ConvertFrameNumber</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">env</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>But you must also do three other things:</p>
<ul class="simple">
<li>Write a companion <code class="docutils literal notranslate"><span class="pre">GetParity</span></code> method so that field information is
preserved; for example, <strong>``bool GetParity(int n) { return
child-&gt;GetParity(ConvertFrameNumber(n)); }``</strong>;</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">vi.num_frames</span></code> and/or call <code class="docutils literal notranslate"><span class="pre">vi.SetFPS</span></code> at instance
construction time, if you change the frame count or frame rate;</li>
<li>Decide what you want to do with the audio track, and write a
<code class="docutils literal notranslate"><span class="pre">GetAudio</span></code> method if necessary.</li>
</ul>
</div>
</div>
<div class="section" id="other-useful-methods-in-iscriptenvironment">
<h3><a class="toc-backref" href="#id10">Other useful methods in IScriptEnvironment</a><a class="headerlink" href="#other-useful-methods-in-iscriptenvironment" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">__declspec</span><span class="p">(</span><span class="n">noreturn</span><span class="p">)</span> <span class="n">virtual</span> <span class="n">void</span> <span class="n">ThrowError</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">...</span><span class="p">);</span>
</pre></div>
</div>
<p>This function throws an exception (of type <code class="docutils literal notranslate"><span class="pre">AvisynthError</span></code>). Usually, your
error message will end up being displayed on the user’s screen in lieu of the
video clip they were expecting.</p>
<p>You can safely call <code class="docutils literal notranslate"><span class="pre">ThrowError</span></code> from anywhere except inside <code class="docutils literal notranslate"><span class="pre">GetParity</span></code>
and <code class="docutils literal notranslate"><span class="pre">GetVideoInfo</span></code>.</p>
<p>I declared this function as <code class="docutils literal notranslate"><span class="pre">__declspec(noreturn)</span></code> to prevent “not all
control paths return a value” warnings. But it didn’t work – I still get the
warnings. Go figure.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virtual</span> <span class="n">long</span> <span class="n">GetCPUFlags</span><span class="p">();</span>
</pre></div>
</div>
<p>This is exactly the same as the corresponding VirtualDub function (to the
point of being implemented with code taken directly from VirtualDub – sorry
Avery ;-) ).</p>
<p>To find out if you’re running on a CPU that supports MMX, test
<code class="docutils literal notranslate"><span class="pre">env-&gt;GetCPUFlags()</span> <span class="pre">&amp;</span> <span class="pre">CPUF_MMX</span></code>. There’s a complete list of flags in
<code class="docutils literal notranslate"><span class="pre">avisynth.h</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virtual</span> <span class="n">char</span><span class="o">*</span> <span class="n">SaveString</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="nb">int</span> <span class="n">length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>This function copies its argument to a safe “permanent” location and returns
a pointer to the new location.</p>
<p>Each <code class="docutils literal notranslate"><span class="pre">ScriptEnvironment</span></code> instance has a buffer set aside for storing
strings, which is expanded as needed. The strings are not deleted until the
<code class="docutils literal notranslate"><span class="pre">ScriptEnvironment</span></code> instance goes away (when the script file is closed,
usually). This is usually all the permanence that is needed, since all
related filter instances will already be gone by then.</p>
<p>The returned pointer is not const-qualified, and you’re welcome to write to
it, as long as you don’t stray beyond the bounds of the string.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virtual</span> <span class="n">char</span><span class="o">*</span> <span class="n">Sprintf</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">...</span><span class="p">);</span>

<span class="n">virtual</span> <span class="n">char</span><span class="o">*</span> <span class="n">VSprintf</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">char</span><span class="o">*</span> <span class="n">val</span><span class="p">);</span>
</pre></div>
</div>
<p>These store strings away in the same way as <code class="docutils literal notranslate"><span class="pre">SaveString</span></code>, but they treat
their arguments like <code class="docutils literal notranslate"><span class="pre">printf</span></code> and <code class="docutils literal notranslate"><span class="pre">vprintf</span></code>.</p>
<p>Currently there’s a size limit of 4096 characters on strings created this
way. (The implementation uses <code class="docutils literal notranslate"><span class="pre">_vsnprintf</span></code>, so you don’t need to worry
about buffer overrun.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virtual</span> <span class="n">AVSValue</span> <span class="n">Invoke</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">const</span> <span class="n">AVSValue</span> <span class="n">args</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span><span class="o">**</span> <span class="n">arg_names</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>You can use this to call a script function. There are many script functions
which can be useful from other filters; for example, the <code class="docutils literal notranslate"><span class="pre">Bob</span></code> filter uses
<code class="docutils literal notranslate"><span class="pre">SeparateFields</span></code>, and several source filters use <code class="docutils literal notranslate"><span class="pre">UnalignedSplice</span></code>. Some
functions, like <code class="docutils literal notranslate"><span class="pre">Weave</span></code>, are implemented entirely in terms of other
functions.</p>
<p>If you’re calling a function taking exactly one argument, you can simply pass
it in the <code class="docutils literal notranslate"><span class="pre">args</span></code> parameter; <code class="docutils literal notranslate"><span class="pre">Invoke</span></code> will convert it into an array for
you. In order to call a function taking multiple arguments, you will need to
create the array yourself; it can be done like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AVSValue</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">clip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="mf">4.7</span><span class="p">,</span> <span class="s2">&quot;my hovercraft is</span>
<span class="n">full</span> <span class="n">of</span> <span class="n">eels</span><span class="s2">&quot; };</span>
<span class="n">env</span><span class="o">-&gt;</span><span class="n">Invoke</span><span class="p">(</span><span class="s2">&quot;Frob&quot;</span><span class="p">,</span> <span class="n">AVSValue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
<p>In this case <code class="docutils literal notranslate"><span class="pre">Frob</span></code> would need to have a parameter-type string like “cibfs”
or “cfbfs” or “cf.*”.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">arg_names</span></code> parameter can be used to specify named arguments. Named
arguments can also be given positionally, if you prefer.</p>
<p><code class="docutils literal notranslate"><span class="pre">Invoke</span></code> throws <code class="docutils literal notranslate"><span class="pre">IScriptEnvironment::NotFound</span></code> if it can’t find a
matching function prototype. You should be prepared to catch this unless you
know that the function exists and will accept the given arguments.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virtual</span> <span class="n">void</span> <span class="n">BitBlt</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">dstp</span><span class="p">,</span> <span class="nb">int</span> <span class="n">dst_pitch</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span><span class="o">*</span> <span class="n">srcp</span><span class="p">,</span>
                    <span class="nb">int</span> <span class="n">src_pitch</span><span class="p">,</span> <span class="nb">int</span> <span class="n">row_size</span><span class="p">,</span> <span class="nb">int</span> <span class="n">height</span><span class="p">);</span>
</pre></div>
</div>
<p>This brilliantly-named function does a line-by-line copy from the source to
the destination. It’s useful for quite a number of things; the built-in
filters <code class="docutils literal notranslate"><span class="pre">DoubleWeave</span></code>, <code class="docutils literal notranslate"><span class="pre">FlipVertical</span></code>, <code class="docutils literal notranslate"><span class="pre">AddBorders</span></code>, <code class="docutils literal notranslate"><span class="pre">PeculiarBlend</span></code>,
<code class="docutils literal notranslate"><span class="pre">StackVertical</span></code>, <code class="docutils literal notranslate"><span class="pre">StackHorizontal</span></code>, and <code class="docutils literal notranslate"><span class="pre">ShowFiveVersions</span></code> all use it
to do their dirty work.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">void</span> <span class="p">(</span><span class="n">__cdecl</span> <span class="o">*</span><span class="n">ShutdownFunc</span><span class="p">)(</span><span class="n">void</span><span class="o">*</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">IScriptEnvironment</span><span class="o">*</span> <span class="n">env</span><span class="p">);</span>
<span class="n">virtual</span> <span class="n">void</span> <span class="n">AtExit</span><span class="p">(</span><span class="n">ShutdownFunc</span> <span class="n">function</span><span class="p">,</span> <span class="n">void</span><span class="o">*</span> <span class="n">user_data</span><span class="p">);</span>
</pre></div>
</div>
<p>If you find yourself wanting an <code class="docutils literal notranslate"><span class="pre">AvisynthPluginShutdown</span></code> export, this is
the way to get that effect. Functions added through <code class="docutils literal notranslate"><span class="pre">AtExit</span></code> are called (in
the opposite order that they were added) when the corresponding
ScriptEnvironment goes away.</p>
<hr class="docutils" />
<img alt="Ben Rudiak-Gould" src="../../_images/sig.gif" />
<hr class="docutils" />
<div class="section" id="notes-to-ben-s-docs">
<h4><a class="toc-backref" href="#id11">Notes to Ben’s docs</a><a class="headerlink" href="#notes-to-ben-s-docs" title="Permalink to this headline">¶</a></h4>
<p>Plugin exported function name is replaced from <code class="docutils literal notranslate"><span class="pre">AvisynthPluginInit</span></code> for
AviSynth 1.0-2.0 to <code class="docutils literal notranslate"><span class="pre">AvisynthPluginInit2</span></code> for AviSynth 2.5. For other
changes see <a class="reference internal" href="AviSynthTwoFiveSDK.html"><span class="doc">AviSynthTwoFiveSDK.</span></a></p>
<p>For AviSynth 2.5, the converted <a class="reference internal" href="TwoFiveInvert.html"><span class="doc">TwoFiveInvert</span></a> plugin filter source.</p>
<p>Back to <a class="reference internal" href="FilterSDK.html"><span class="doc">FilterSDK</span></a></p>
<p>$Date: 2006/11/08 20:40:16 $</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="C_api.html" title="C API"
             >next</a> |</li>
        <li class="right" >
          <a href="AviSynthTwoFiveSDK.html" title="AviSynthTwoFiveSDK"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2000-2019, AviSynth and AviSynth+ contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>