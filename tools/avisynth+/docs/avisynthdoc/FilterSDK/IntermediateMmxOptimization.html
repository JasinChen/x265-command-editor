

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>IntermediateMmxOptimization &#8212; AviSynth+ 3.4 documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../_static/AvsiDoc.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="InternalFunctions" href="InternalFunctions.html" />
    <link rel="prev" title="InterleavedImageFormat" href="InterleavedImageFormat.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="InternalFunctions.html" title="InternalFunctions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="InterleavedImageFormat.html" title="InterleavedImageFormat"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/DocIcon-Large.svg" alt="Logo"/>
            </a></p>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">IntermediateMmxOptimization</a><ul>
<li><a class="reference internal" href="#omake">Omake</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="InterleavedImageFormat.html"
                        title="previous chapter">InterleavedImageFormat</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="InternalFunctions.html"
                        title="next chapter">InternalFunctions</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/avisynthdoc/FilterSDK/IntermediateMmxOptimization.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="intermediatemmxoptimization">
<h1><a class="reference external" href="http://www.avisynth.org/IntermediateMmxOptimization">IntermediateMmxOptimization</a><a class="headerlink" href="#intermediatemmxoptimization" title="Permalink to this headline">¶</a></h1>
<p><em>phaeron writes</em>:</p>
<p>Additive blending is a relatively simple, common, and useful operation. It
takes two images and adds them together, saturating the result to white. It’s
useful for some kinds of overlays, as well as incrementally building a final
image from components. We’ll start with a simple scalar version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">additiveblend1</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span> <span class="n">quads</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">quads</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

    <span class="n">do</span> <span class="p">{</span>
        <span class="n">unsigned</span> <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span><span class="p">)</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
        <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
        <span class="o">++</span><span class="n">src</span><span class="p">;</span>
        <span class="o">++</span><span class="n">dst</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="nb">bytes</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code works a byte at a time and works equally well for any byte-per-
channel format, including RGB24, RGB32, YUY2, and YV12. It runs at a dismal
16 clocks/byte on a 1.6GHz Pentium 4.</p>
<p><strong>Tip:</strong> The CPU’s time stamp counter, accessible via the RDTSC instruction,
is a great way to benchmark small pieces of code. However, the results can be
heavily affected by cache effects. For code that is deterministic and quick,
running the test twice in a row and taking the second timing can eliminate
most cache effects.</p>
<p>Now, let’s rewrite it in MMX.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">additiveblend2</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span> <span class="n">quads</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__asm</span> <span class="p">{</span>
        <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">src</span>
        <span class="n">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">dst</span>
        <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">quads</span>
        <span class="n">pxor</span>        <span class="n">mm7</span><span class="p">,</span> <span class="n">mm7</span>
<span class="n">top</span><span class="p">:</span>
        <span class="n">movd</span>        <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="p">]</span>     <span class="p">;</span><span class="n">load</span> <span class="n">four</span> <span class="n">source</span> <span class="nb">bytes</span>
        <span class="n">movd</span>        <span class="n">mm1</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="p">]</span>     <span class="p">;</span><span class="n">load</span> <span class="n">four</span> <span class="n">destination</span>
        <span class="nb">bytes</span>
        <span class="n">punpcklbw</span>   <span class="n">mm0</span><span class="p">,</span> <span class="n">mm7</span>       <span class="p">;</span><span class="n">unpack</span> <span class="n">source</span> <span class="nb">bytes</span> <span class="n">to</span>
        <span class="n">words</span>
        <span class="n">punpcklbw</span>   <span class="n">mm1</span><span class="p">,</span> <span class="n">mm7</span>       <span class="p">;</span><span class="n">unpack</span> <span class="n">destination</span> <span class="nb">bytes</span>
        <span class="n">to</span> <span class="n">words</span>
        <span class="n">paddw</span>       <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span>       <span class="p">;</span><span class="n">add</span> <span class="n">words</span> <span class="n">together</span>
        <span class="n">packuswb</span>    <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span>       <span class="p">;</span><span class="n">pack</span> <span class="n">words</span> <span class="k">with</span>
        <span class="n">saturation</span>
        <span class="n">movd</span>        <span class="p">[</span><span class="n">edx</span><span class="p">],</span> <span class="n">mm0</span>     <span class="p">;</span><span class="n">store</span> <span class="n">blended</span> <span class="n">result</span>
        <span class="n">add</span>     <span class="n">ecx</span><span class="p">,</span> <span class="mi">4</span>             <span class="p">;</span><span class="n">advance</span> <span class="n">source</span> <span class="n">pointer</span>
        <span class="n">add</span>     <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span>             <span class="p">;</span><span class="n">advance</span> <span class="n">destination</span>
        <span class="n">pointer</span>
        <span class="n">dec</span>     <span class="n">eax</span>                <span class="p">;</span><span class="n">loop</span> <span class="n">back</span> <span class="n">until</span> <span class="n">done</span>
        <span class="n">jne</span>     <span class="n">top</span>
        <span class="n">emms</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This version runs <em>much</em> better on a random 1K sample, at 1.64 clocks/byte.
However, we can do better. Unpacking to 16-bit words is generally required in
most MMX routines but it’s a total waste here, as the CPU has saturating add
instructions that work directly on bytes. We can use those instead.</p>
<p><strong>Tip:</strong> MMX has a lot of interesting instructions, such as saturating adds
and subtracts, clamping packs, and multiply-plus-shift instructions. Learning
to use these effectively can improve the performance of your code. However,
there are a few omissions in the basic MMX set, including unsigned
multiplies, byte shifts, and saturating 32-bit operations, that you should be
aware of.</p>
<p>So here’s the version using the saturating PADDUSB (packed add with unsigned
byte saturation) instruction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">additiveblend3</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span> <span class="n">quads</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__asm</span> <span class="p">{</span>
        <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">src</span>
        <span class="n">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">dst</span>
        <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">quads</span>
<span class="n">top</span><span class="p">:</span>
        <span class="n">movd</span>        <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="p">]</span>
        <span class="n">movd</span>        <span class="n">mm1</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="p">]</span>
        <span class="n">paddusb</span>     <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span>
        <span class="n">movd</span>        <span class="p">[</span><span class="n">edx</span><span class="p">],</span> <span class="n">mm0</span>
        <span class="n">add</span>     <span class="n">ecx</span><span class="p">,</span> <span class="mi">4</span>
        <span class="n">add</span>     <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span>
        <span class="n">dec</span>     <span class="n">eax</span>
        <span class="n">jne</span>     <span class="n">top</span>
        <span class="n">emms</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This version is still faster at 1.27 clocks/byte and is simpler, too. But why
are we still doing 4 bytes at a time, when we could be doing 8?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">additiveblend4</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span> <span class="n">quads</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__asm</span> <span class="p">{</span>
        <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">src</span>
        <span class="n">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">dst</span>
        <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">quads</span>
        <span class="n">pxor</span>        <span class="n">mm7</span><span class="p">,</span> <span class="n">mm7</span>
<span class="n">top</span><span class="p">:</span>
        <span class="n">movq</span>        <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="p">]</span>
        <span class="n">paddusb</span>     <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="p">]</span>
        <span class="n">movq</span>        <span class="p">[</span><span class="n">edx</span><span class="p">],</span> <span class="n">mm0</span>
        <span class="n">add</span>     <span class="n">ecx</span><span class="p">,</span> <span class="mi">8</span>
        <span class="n">add</span>     <span class="n">edx</span><span class="p">,</span> <span class="mi">8</span>
        <span class="n">sub</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">2</span>
        <span class="n">jne</span>     <span class="n">top</span>
        <span class="n">emms</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Although we only doubled the parallism of the loop, this change makes a huge
difference and kicks us all the way up to 0.49 clocks/pixel. Now notice that
the scalar code is beginning to take a lot of the inner loop – in fact, half
of it. We can eliminate the pointer updates by switching to array notation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">additiveblend5</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span> <span class="n">quads</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__asm</span> <span class="p">{</span>
        <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">src</span>
        <span class="n">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">dst</span>
        <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">quads</span>
        <span class="n">shl</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">2</span>
        <span class="n">add</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
        <span class="n">add</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">eax</span>
        <span class="n">neg</span>     <span class="n">eax</span>
<span class="n">top</span><span class="p">:</span>
        <span class="n">movq</span>        <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="n">eax</span><span class="p">]</span>
        <span class="n">paddusb</span>     <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="p">]</span>
        <span class="n">movq</span>        <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="p">],</span> <span class="n">mm0</span>
        <span class="n">add</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">8</span>
        <span class="n">jne</span>     <span class="n">top</span>
        <span class="n">emms</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is a slight trick here, in that we index negatively from the end of the
arrays rather than positively from the start, and count up instead of down.
Removing the pointer operations trims execution time by a tiny amount, down
to 0.48 clocks/pixel. We’re still not done yet, though. Let’s unroll the
loop. That way, the CPU has less loop overhead instructions to execute, and
also relaxes the loop-carried dependency on the loop count (EAX in a loop
iteration is dependent on the last loop’s EAX, which is dependent on EAX from
the loop before that, etc).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">additiveblend6</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span> <span class="n">quads</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__asm</span> <span class="p">{</span>
        <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">src</span>
        <span class="n">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">dst</span>
        <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">quads</span>
        <span class="n">shl</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">2</span>
        <span class="n">add</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
        <span class="n">add</span>     <span class="n">edx</span><span class="p">,</span> <span class="n">eax</span>
        <span class="n">neg</span>     <span class="n">eax</span>
<span class="n">top</span><span class="p">:</span>
        <span class="n">movq</span>        <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="n">eax</span><span class="p">]</span>
        <span class="n">movq</span>        <span class="n">mm1</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">paddusb</span>     <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="p">]</span>
        <span class="n">paddusb</span>     <span class="n">mm1</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">movq</span>        <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="p">],</span> <span class="n">mm0</span>
        <span class="n">movq</span>        <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span> <span class="n">mm1</span>
        <span class="n">add</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">16</span>
        <span class="n">jne</span>     <span class="n">top</span>
        <span class="n">emms</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This version now runs at 0.42 clocks/pixel, about 38x faster than the
original scalar version. That’s fast enough, right? Well, yes, except for one
problem: it’s wrong. Namely, this routine handles 16 bytes at a time instead
of 4 bytes at a time, so if the quad count isn’t divisible by 4, this routine
doesn’t work properly. Whoops.</p>
<p><strong>Tip:</strong> Faster code is generally less desirable than working code.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">additiveblend7</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span> <span class="n">quads</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__asm</span> <span class="p">{</span>
            <span class="n">mov</span>             <span class="n">ecx</span><span class="p">,</span> <span class="n">src</span>
            <span class="n">mov</span>             <span class="n">edx</span><span class="p">,</span> <span class="n">dst</span>
            <span class="n">mov</span>             <span class="n">eax</span><span class="p">,</span> <span class="n">quads</span>
            <span class="n">shl</span>             <span class="n">eax</span><span class="p">,</span> <span class="mi">2</span>
            <span class="n">lea</span>             <span class="n">ecx</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="n">eax</span><span class="o">-</span><span class="mi">12</span><span class="p">]</span>
            <span class="n">lea</span>             <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="o">-</span><span class="mi">12</span><span class="p">]</span>
            <span class="n">neg</span>             <span class="n">eax</span>
            <span class="n">add</span>             <span class="n">eax</span><span class="p">,</span> <span class="mi">12</span>
            <span class="n">jc</span>              <span class="n">look_for_oddballs</span>
<span class="n">top</span><span class="p">:</span>
            <span class="n">movq</span>            <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="n">eax</span><span class="p">]</span>
            <span class="n">movq</span>            <span class="n">mm1</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
            <span class="n">paddusb</span>         <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="p">]</span>
            <span class="n">paddusb</span>         <span class="n">mm1</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
            <span class="n">movq</span>            <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="p">],</span> <span class="n">mm0</span>
            <span class="n">movq</span>            <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span> <span class="n">mm1</span>
            <span class="n">add</span>             <span class="n">eax</span><span class="p">,</span> <span class="mi">16</span>
            <span class="n">jnc</span>             <span class="n">top</span>
<span class="n">look_for_oddballs</span><span class="p">:</span>
            <span class="n">sub</span>             <span class="n">eax</span><span class="p">,</span> <span class="mi">12</span>
            <span class="n">jnc</span>             <span class="n">no_oddballs</span>
<span class="n">oddball_loop</span><span class="p">:</span>
            <span class="n">movd</span>            <span class="n">mm0</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span>
            <span class="n">movd</span>            <span class="n">mm1</span><span class="p">,</span> <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span>
            <span class="n">paddusb</span>         <span class="n">mm0</span><span class="p">,</span> <span class="n">mm1</span>
            <span class="n">movd</span>            <span class="p">[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="o">+</span><span class="mi">12</span><span class="p">],</span> <span class="n">mm0</span>
            <span class="n">add</span>             <span class="n">eax</span><span class="p">,</span> <span class="mi">4</span>
            <span class="n">jne</span>             <span class="n">oddball_loop</span>
<span class="n">no_oddballs</span><span class="p">:</span>
            <span class="n">emms</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here is the final version. It’s probably still not as fast as it could be but
for most uses it’s fast enough. Unfortunately, the code to handle odd fixups
at the end of the line takes more code than the optimized version. It is
often the case that handling odd cases will greatly complicate an optimized
routine. There is an trick to handle odd widths that unfortunately cannot be
used here, but is useful when the destination and sources don’t overlap: back
off the source and destination pointers and redo some bytes that have already
been done. For instance, if a routine handles 8 bytes at a time and is asked
to do 21 bytes, do 16 bytes in the fast loop, then do 8 unaligned bytes at
the end with bytes 13-15 getting redone. This can let you handle odd widths
with very little code.</p>
<hr class="docutils" />
<div class="section" id="omake">
<h2>Omake<a class="headerlink" href="#omake" title="Permalink to this headline">¶</a></h2>
<p>Remember that scalar version at the top that ran at 16 clocks/pixel? Well,
that was a pretty bad scalar version. Try this one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">additiveblend1s</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">const</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="nb">int</span> <span class="n">quads</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">unsigned</span> <span class="o">*</span><span class="n">dst2</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">unsigned</span> <span class="o">*</span><span class="n">src2</span> <span class="o">=</span> <span class="p">(</span><span class="n">const</span> <span class="n">unsigned</span> <span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>

    <span class="n">do</span> <span class="p">{</span>
            <span class="n">unsigned</span> <span class="n">a</span> <span class="o">=</span> <span class="n">src2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">unsigned</span> <span class="n">b</span> <span class="o">=</span> <span class="n">dst2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">unsigned</span> <span class="n">sats</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="n">a</span><span class="o">^</span><span class="n">b</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xfefefefe</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
<span class="mh">0x80808080</span><span class="p">;</span>
            <span class="n">sats</span> <span class="o">=</span> <span class="n">sats</span> <span class="o">+</span> <span class="n">sats</span> <span class="o">-</span> <span class="p">(</span><span class="n">sats</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>

            <span class="n">dst2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">|</span><span class="n">sats</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">&amp;~</span><span class="n">sats</span><span class="p">);</span>

            <span class="o">++</span><span class="n">src2</span><span class="p">;</span>
            <span class="o">++</span><span class="n">dst2</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="n">quads</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This version handles 32 bits at a time, and runs at 3.43 clocks/byte. MMX is
still faster here, but there are some cases in which it isn’t – for
instance, when I tried writing an HSV filter, an optimized scalar version
turned out to be faster than an optimized MMX version. So don’t think that
MMX is always the best way.</p>
<p>Back to <a class="reference internal" href="AssemblerOptimizing.html"><span class="doc">AssemblerOptimizing</span></a></p>
<p>$Date: 2006/11/24 18:21:26 $</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="InternalFunctions.html" title="InternalFunctions"
             >next</a> |</li>
        <li class="right" >
          <a href="InterleavedImageFormat.html" title="InterleavedImageFormat"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2000-2019, AviSynth and AviSynth+ contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>