

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>The script execution model - Scope and lifetime of variables &#8212; AviSynth+ 3.4 documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../_static/AvsiDoc.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="The script execution model - Performance considerations" href="script_ref_execution_model_perf_cons.html" />
    <link rel="prev" title="The script execution model - The filter graph" href="script_ref_execution_model_filter_graph.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="script_ref_execution_model_perf_cons.html" title="The script execution model - Performance considerations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="script_ref_execution_model_filter_graph.html" title="The script execution model - The filter graph"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/DocIcon-Large.svg" alt="Logo"/>
            </a></p>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The script execution model - Scope and lifetime of variables</a><ul>
<li><a class="reference internal" href="#global-scope">Global scope</a></li>
<li><a class="reference internal" href="#local-scope">Local scope</a></li>
<li><a class="reference internal" href="#lifetime-of-variables">Lifetime of variables</a></li>
<li><a class="reference internal" href="#a-variables-scope-and-lifetime-example">A variables scope and lifetime example</a></li>
<li><a class="reference internal" href="#code-injecting-language-facilities-and-scopes">Code-injecting language facilities and scopes</a><ul>
<li><a class="reference internal" href="#import-and-eval">Import and Eval</a></li>
<li><a class="reference internal" href="#runtime-scripts">Runtime scripts</a></li>
<li><a class="reference internal" href="#the-try-catch-block">The try…catch block</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="script_ref_execution_model_filter_graph.html"
                        title="previous chapter">The script execution model - The filter graph</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="script_ref_execution_model_perf_cons.html"
                        title="next chapter">The script execution model - Performance considerations</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/avisynthdoc/script_ref/script_ref_execution_model_lifetime_variables.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-script-execution-model-scope-and-lifetime-of-variables">
<h1><a class="toc-backref" href="#id1">The script execution model - Scope and lifetime of variables</a><a class="headerlink" href="#the-script-execution-model-scope-and-lifetime-of-variables" title="Permalink to this headline">¶</a></h1>
<p>There are essentially two scope types in the AviSynth script language:</p>
<div class="toctree-wrapper compound">
</div>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#the-script-execution-model-scope-and-lifetime-of-variables" id="id1">The script execution model - Scope and lifetime of variables</a><ul>
<li><a class="reference internal" href="#global-scope" id="id2">Global scope</a></li>
<li><a class="reference internal" href="#local-scope" id="id3">Local scope</a></li>
<li><a class="reference internal" href="#lifetime-of-variables" id="id4">Lifetime of variables</a></li>
<li><a class="reference internal" href="#a-variables-scope-and-lifetime-example" id="id5">A variables scope and lifetime example</a></li>
<li><a class="reference internal" href="#code-injecting-language-facilities-and-scopes" id="id6">Code-injecting language facilities and scopes</a><ul>
<li><a class="reference internal" href="#import-and-eval" id="id7">Import and Eval</a></li>
<li><a class="reference internal" href="#runtime-scripts" id="id8">Runtime scripts</a></li>
<li><a class="reference internal" href="#the-try-catch-block" id="id9">The try…catch block</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="global-scope">
<h2><a class="toc-backref" href="#id2">Global scope</a><a class="headerlink" href="#global-scope" title="Permalink to this headline">¶</a></h2>
<p>Every <a class="reference internal" href="../syntax/syntax_script_variables.html"><span class="doc">variable</span></a> placed in this scope can be freely accessed from any nested
block of script code at any level of nesting. That is, you can access a
global from the top-level script block, from inside a user <a class="reference internal" href="../syntax/syntax_userdefined_scriptfunctions.html"><span class="doc">function</span></a> at any
level of recursion, as well as from inside <a class="reference internal" href="../syntax/syntax_runtime_environment.html"><span class="doc">runtime scripts</span></a>.</p>
<p><strong>Note:</strong> One important precondition for the above rule to apply is that <em>you
must not have a local variable with the same name as a global one</em>. If you
define a local variable with the same name as a global one, then you can no
longer get (read) the value of the global variable in that specific local
scope. This is because AviSynth when given a variable’s name it first
searches in the current local scope; only if the search fails the global
scope is searched. You can however set (write) the global’s value, since in
that case the use of the keyword <code class="docutils literal notranslate"><span class="pre">global</span></code> distinguishes between a global
and a local variable.</p>
</div>
<div class="section" id="local-scope">
<h2><a class="toc-backref" href="#id3">Local scope</a><a class="headerlink" href="#local-scope" title="Permalink to this headline">¶</a></h2>
<p>Variables placed in this scope can be accessed (read or written) <em>only</em> from
script code within that scope. This allows the isolation of nested local
scopes and makes the creation and usage of script functions possible.</p>
<p>The most important local scope is the top-level script scope (the one that is
created just before the executing script is parsed and evaluated). All non-
global variables defined inside the script-level source code reside there.
All the other local scopes are created due to function calls and are nested
inside this one.</p>
<p>Nested local scopes result from function or filter calls (plugin writers can
create nested scopes through <code class="docutils literal notranslate"><span class="pre">env-&gt;PushContext()</span></code> and
<code class="docutils literal notranslate"><span class="pre">env-&gt;PopContext()</span></code>) and can be created at an arbitrary depth. For example,
a recursive user function such as the one below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>function strfill(string s, int count) {
    return count &gt; 0 ? s + strfill(s, count - 1) : &quot;&quot;
}
</pre></div>
</div>
<p>will result during its evaluation in the creation and subsequent destruction
of eleven nested local scopes if called with a value ten for its <code class="docutils literal notranslate"><span class="pre">count</span></code>
argument.</p>
</div>
<div class="section" id="lifetime-of-variables">
<h2><a class="toc-backref" href="#id4">Lifetime of variables</a><a class="headerlink" href="#lifetime-of-variables" title="Permalink to this headline">¶</a></h2>
<p>The lifetime of variables defined at the global and top-level script (local)
scope spans from the time of the definition (that is the first statement that
assigns a value to them) to the end of frame serving and the unload of
<code class="docutils literal notranslate"><span class="pre">avisynth.dll</span></code>.</p>
<p>The lifetime of variables defined at nested local scopes spans from the time
of the definition in the nested local scope to the end of the nested local
scope’s lifetime. Since nested local scopes result from function / filter
calls, the nested scope’s lifetime is the lifetime of the function / filter
call.</p>
</div>
<div class="section" id="a-variables-scope-and-lifetime-example">
<h2><a class="toc-backref" href="#id5">A variables scope and lifetime example</a><a class="headerlink" href="#a-variables-scope-and-lifetime-example" title="Permalink to this headline">¶</a></h2>
<p>To clarify the statements of the previous section, the following example
demonstrates the scope and lifetime of variables in a moderately complex
AviSynth script that also includes runtime scripts.</p>
<p>What the script does is to divide a clip (after some processing tweaks) in 4
equal-sized regions and evaluate the average luma of each region per frame.
If this is outside a range defined by two thresholds, the corresponding
region is turned to all black (if below) or white (if above) for that frame.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>function Quartile(clip c, int quartile) {
    Assert(quartile &gt;= 0 &amp;&amp; quartile &lt;= 3, &quot;Invalid
    Quartile!&quot;)
    hw = Int(c.Width() / 2)
    hh = Int(c.Height() / 2)
    return Select(quartile, \
        Crop(c, 0, 0, hw, hh), Crop(c, hw, 0, hw, hh), \
        Crop(c, 0, hh, hw, hh), Crop(c, hw, hh, hw, hh))
}

function bracket_luma(clip c, float th1, float th2) {
    Assert(0 &lt;= th1 &amp;&amp; th1 &lt; th2 &amp;&amp; th2 &lt;= 255, &quot;Invalid
    thresholds!&quot;)
    script =  &quot;th1 = &quot; + String(th1) + Chr(13) + Chr(10) + \
        &quot;th2 = &quot; + String(th2) + &quot;&quot;&quot;
        avl = AverageLuma()
        return avl &lt;= th1 ? last.BlankClip() : (avl &gt;= th2
        ? \
            last.BlankClip(color=color_white) : last)
        &quot;&quot;&quot;
    return ScriptClip(c, script)
}

clp = AviSource(&quot;myclip.avi&quot;)
clp = Tweak(clp, hue=20, sat=1.1)
threshold1 = 12.0
threshold2 = 78.0
q0 = Quartile(clp, 0).bracket_luma(threshold1, threshold2)
q1 = Quartile(clp, 1).bracket_luma(threshold1, threshold2)
q2 = Quartile(clp, 2).bracket_luma(threshold1, threshold2)
q3 = Quartile(clp, 3).bracket_luma(threshold1, threshold2)
StackVertical(StackHorizontal(q0, q1), StackHorizontal(q2, q3))
</pre></div>
</div>
<p>The scope and lifetime of all variables in the example script is presented in
the following timeline (the <code class="docutils literal notranslate"><span class="pre">color_white</span></code> global is from the autoloaded
.avsi that ships with AviSynth):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+--</span> <span class="n">scope</span> <span class="o">--+-------</span> <span class="n">parsing</span> <span class="n">phase</span> <span class="o">----------------------&gt;+-----</span> <span class="n">frameserving</span> <span class="n">phase</span> <span class="o">--------&gt;+</span>
<span class="o">|</span>           <span class="o">|</span>                                             <span class="o">|</span>                                  <span class="o">|</span>
<span class="o">|</span> <span class="k">global</span>    <span class="o">|</span><span class="n">color_white</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-&gt;|</span>
<span class="o">+-----------+---------------------------------------------+----------------------------------|</span>
<span class="o">|</span> <span class="n">local</span><span class="p">,</span>    <span class="o">|</span><span class="n">clp</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-&gt;|</span>
<span class="o">|</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="o">|</span> <span class="n">threshold1</span><span class="p">,</span><span class="n">threshold2</span><span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-&gt;|</span>
<span class="o">|</span>           <span class="o">|</span>  <span class="n">q0</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">q3</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-&gt;|</span>
<span class="o">|</span>           <span class="o">|</span>                                             <span class="o">|</span><span class="n">avl</span><span class="p">,</span><span class="n">th1</span><span class="p">,</span><span class="n">th2</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-&gt;|</span>
<span class="o">+-----------+---------------------------------------------+----------------------------------|</span>
<span class="o">|</span> <span class="n">local</span><span class="p">,</span>    <span class="o">|</span>   <span class="n">c</span><span class="p">,</span>  <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-&gt;|</span>           <span class="o">|</span>                <span class="o">|</span>
<span class="o">|</span> <span class="n">Quartile</span>  <span class="o">|</span>   <span class="n">quartile</span><span class="p">,</span> <span class="o">-&gt;|</span>           <span class="o">|</span> <span class="n">repeated</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">function</span>  <span class="o">|</span>    <span class="n">hw</span><span class="p">,</span><span class="n">hh</span><span class="o">-</span> <span class="o">-</span> <span class="o">-&gt;|</span>           <span class="o">|</span> <span class="n">three</span> <span class="n">times</span><span class="p">,</span>   <span class="o">|</span>
<span class="o">+-----------+--------------------------&gt;|</span> <span class="ow">in</span> <span class="n">immediate</span> <span class="o">-&gt;|</span>
<span class="o">|</span> <span class="n">local</span><span class="p">,</span>    <span class="o">|</span>   <span class="o">|</span>            <span class="n">c</span><span class="p">,</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-&gt;|</span> <span class="n">succession</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">bracket_l</span><span class="o">.|</span>   <span class="o">|</span>            <span class="n">th1</span><span class="p">,</span><span class="n">th2</span><span class="p">,</span> <span class="o">-&gt;|</span>                <span class="o">|</span>
<span class="o">|</span> <span class="n">function</span>  <span class="o">|</span>   <span class="o">|</span>             <span class="n">script</span><span class="o">-</span> <span class="o">-&gt;|</span>                <span class="o">|</span>
<span class="o">+-----------+---------------------------------------------+----------------------------------|</span>
</pre></div>
</div>
</div>
<div class="section" id="code-injecting-language-facilities-and-scopes">
<h2><a class="toc-backref" href="#id6">Code-injecting language facilities and scopes</a><a class="headerlink" href="#code-injecting-language-facilities-and-scopes" title="Permalink to this headline">¶</a></h2>
<p>There are certain language constructs (functions, filters and control
structures) that allow the injection of code in the script, ie the execution
of arbitrary sequences of AviSynth script language <a class="reference internal" href="../syntax/syntax_ref.html"><span class="doc">statements</span></a>.</p>
<p>This is a <em>very</em> useful functionality that allows among other things dynamic
code evaluation, the creation of <a class="reference internal" href="script_ref_block_statements.html"><span class="doc">block statements</span></a> and <a class="reference internal" href="script_ref_arrays.html"><span class="doc">arrays</span></a>, the
organisation of AviSynth code in libraries, etc. However, there are some
subtle issues regarding variables’ scope and visibility that can lead to
surprises if not fully understood.</p>
<div class="section" id="import-and-eval">
<h3><a class="toc-backref" href="#id7">Import and Eval</a><a class="headerlink" href="#import-and-eval" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../corefilters/import.html"><span class="doc">Import</span></a> and <a class="reference internal" href="../syntax/syntax_internal_functions_control.html"><span class="doc">Eval</span></a> evaluate the passed-in script source code in the
context of the current local scope.</p>
<p>This means that variables contained in the top-level scope of the imported
script or in the code string passed to Eval() are created inside the current
local scope and become available for read/write to the following script
source code. For example:</p>
<p><strong>1. File “a.avs”</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">BlankClip</span><span class="p">(</span><span class="n">pixel_type</span><span class="o">=</span><span class="s2">&quot;YV12&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_orange</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>2. File “b.avs”</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;a.avs&quot;</span><span class="p">)</span>
<span class="n">AviSource</span><span class="p">(</span><span class="s2">&quot;myvideo.avi&quot;</span><span class="p">)</span>
<span class="n">Levels</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="o">**</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="o">**</span><span class="n">y</span><span class="o">**</span><span class="p">,</span> <span class="mi">242</span><span class="p">)</span>
<span class="n">Overlay</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="o">**</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">last</span><span class="o">.</span><span class="n">Width</span><span class="o">-</span><span class="mi">320</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">last</span><span class="o">.</span><span class="n">Height</span><span class="o">-</span><span class="mi">240</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;chroma&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition, the imported script or the code string passed to Eval() can use
previously defined in that scope local variables (as well as globals, of
course). For example (the use of multiline triply quoted strings makes easier
the writing of <a class="reference internal" href="script_ref_block_statements.html"><span class="doc">block statements</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>x = 5
AviSource(&quot;aclip.avi&quot;)
f = Framecount()
f &lt; 100 ? Eval(&quot;&quot;&quot;
    Trim(x, f-2)
    x = 0
&quot;&quot;&quot;) : Eval(&quot;&quot;&quot;
    Trim(x, 15*x + 30)
    x = 1
&quot;&quot;&quot;)
x == 0 ? Invert() : Subtitle(String(last.Framecount))
</pre></div>
</div>
<p>Especially the later is something that you must always keep in mind -mostly
for <a class="reference internal" href="../corefilters/import.html"><span class="doc">Import</span></a> since the code is not immediately visible; only the filename
shows up in the script- because it has the potential to introduce bugs by
unexpected overriding of a variable’s value.</p>
<p>Consider, the following example:</p>
<p><strong>1. File “mylib.avsi”</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">preset</span><span class="p">(</span><span class="nb">int</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span> <span class="c1"># 0 to 3</span>
    <span class="k">return</span> <span class="n">Select</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">AviSource</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">),</span> <span class="n">AviSource</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">),</span>
    <span class="n">AviSource</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">),</span> <span class="n">AviSource</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">))</span>
<span class="p">}</span>
<span class="k">global</span> <span class="n">def_preset</span> <span class="o">=</span> <span class="n">preset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>2. File “myscript.avs”</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span> <span class="n">def_preset</span> <span class="o">=</span> <span class="n">AviSource</span><span class="p">(</span><span class="s2">&quot;myfav.avi&quot;</span><span class="p">)</span>
<span class="n">Import</span><span class="p">(</span><span class="s2">&quot;mylib.avsi&quot;</span><span class="p">)</span>
<span class="n">Tweak</span><span class="p">(</span><span class="n">def_preset</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="c1"># oops, using clip from mylib.avsi instead of myscript.avs!</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The imported script changed a previously defined variable and the results
will now be suprising (until of course the bug is discovered).</p>
<p>However, this same feature has a number of interesting possibilities, for
example:</p>
<ul class="simple">
<li>You can define sub-scripts that communicate with the parent script
through a defined set of variables.</li>
<li>You can create libraries (AviSynth include files) that perform
initialisation code based on “environment” variables (the ones you set in
the parent script before importing) and / or return status information
(through a variable that they set at the global or top-script level code)</li>
<li>You can implement <a class="reference internal" href="script_ref_block_statements.html"><span class="doc">block statements</span></a>.</li>
</ul>
<p><strong>Note:</strong> To test for the existence of input/output variables in the above
scenarios try to read their value in a <code class="docutils literal notranslate"><span class="pre">try..catch</span></code> block; else your script
will die hard if for any reason they do not exist.</p>
</div>
<div class="section" id="runtime-scripts">
<h3><a class="toc-backref" href="#id8">Runtime scripts</a><a class="headerlink" href="#runtime-scripts" title="Permalink to this headline">¶</a></h3>
<p>Local variables inside runtime filters’ scripts are <strong>always</strong> binded to the
top-level script local scope; even if the filter calls were made inside a
user function. This is because the parsing of runtime scripts is done <em>after</em>
the parsing of the script, at the frame serving phase. At that point in
script execution, nested local scopes have already vanished and only the
global and the top-level script local scopes survive.</p>
<p>The same is true for the <a class="reference internal" href="../syntax/syntax_runtime_environment.html"><span class="doc">special variables</span></a> set by the runtime filters
(such as for example <code class="docutils literal notranslate"><span class="pre">current_frame</span></code>); they are defined at the top-level
script local scope.</p>
<p>Some consequences of the above setup are the following:</p>
<ul class="simple">
<li>You can use top-level script local variables inside the runtime
scripts to pass information, just as is customary to do with global ones.</li>
<li>You must be careful if you define local variables in your runtime
scripts to not clash with local variables in other runtime scripts in the
filter chain. This is also true for globals, but globals are typically
used for inter-filter communication; use of locals is not so common and
thus may be overlooked by script writers.</li>
<li>Overriding a variable (either local or global) does not have an efect
at the main script, because the evaluation of the main script is done at
the parsing phase, before the execution of any runtime script.</li>
<li>When examining the way that a variable will be modified by a chain of
runtime scripts, you must remember that the evaluation of scripts is done
from bottom to top, just like the fetching of frames.</li>
</ul>
<p>Consider the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>AviSource(&quot;myclip.avi&quot;)
x = 5
fc = Framecount()
fc &gt; 2x ? Trim(x, fc - x) : Trim(0, fc - x)
fc = Framecount()
ScriptClip(&quot;&quot;&quot;Subtitle(&quot;and the value of x is : &quot; + String(x))&quot;&quot;&quot;)
FrameEvaluate(&quot;x = (x % 3 == (fc - x - 1) % 3) ? x + 2 : x - 1&quot;)
FrameEvaluate(&quot;x = current_frame&quot;)
</pre></div>
</div>
<p>The assignment <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">5</span></code> at the main script is used to control trimming of
the source clip. <code class="docutils literal notranslate"><span class="pre">x</span></code> is passed as argument in the <a class="reference internal" href="../corefilters/trim.html"><span class="doc">Trim</span></a> filter during the
script’s parsing phase. Thus the modifications by the runtime scripts that
start at the frame serving phase has no effect on the values passed to Trim.</p>
<p>By the time the first frame will be fetched, <code class="docutils literal notranslate"><span class="pre">x</span></code> will have been overrided
by the <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">current_frame</span></code> assignment in the last <a class="reference internal" href="../corefilters/conditionalfilter.html"><span class="doc">FrameEvaluate</span></a> filter’s
runtime script. Thus its value in the script has no effect (in this
particular case) to the results of the runtime filters processing.</p>
<p>Here, using <code class="docutils literal notranslate"><span class="pre">x</span></code> in all runtime filter scripts does not pose a naming clash
problem. <code class="docutils literal notranslate"><span class="pre">x</span></code> is the variable used to communicate state information along
the runtime filter chain. However, if we have needed a conditional assignment
by frame number and we have accidentally used the following runtime script in
place of the last FrameEvaluate line,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FrameEvaluate</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    fc = 12</span>
<span class="s2">    x = current_frame &lt; fc ? current_frame : fc</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>then there would be a clash with the use of <code class="docutils literal notranslate"><span class="pre">fc</span></code> in the previous line (the
clips framecount would have been overwritten with an unrelated value) and the
logic of our processing would be in error.</p>
</div>
<div class="section" id="the-try-catch-block">
<h3><a class="toc-backref" href="#id9">The try…catch block</a><a class="headerlink" href="#the-try-catch-block" title="Permalink to this headline">¶</a></h3>
<p>This may seem surprising at first, but the <code class="docutils literal notranslate"><span class="pre">try...catch</span></code> block does inject
code in the script (at the scope that contains it). If this code defines new
variables, then those variables are available to the code in the section that
follows the <code class="docutils literal notranslate"><span class="pre">try...catch</span></code> block. More specifically, there are two
possibilities:</p>
<ul class="simple">
<li><em>No error</em> occurs inside the <code class="docutils literal notranslate"><span class="pre">try{...}</span></code> section.</li>
</ul>
<ol class="arabic simple">
<li>All statements of the code contained in the <code class="docutils literal notranslate"><span class="pre">try{...}</span></code> section are
evaluated and affect the script code that follows.</li>
</ol>
<ul class="simple">
<li>An error <em>does</em> occur inside the <code class="docutils literal notranslate"><span class="pre">try{...}</span></code> section.</li>
</ul>
<ol class="arabic simple">
<li>Statements of the code contained in the <code class="docutils literal notranslate"><span class="pre">try{...}</span></code> section up to
the point of error are evaluated and affect the script code that follows.</li>
<li>All statements of the code contained in the <code class="docutils literal notranslate"><span class="pre">catch{...}</span></code> section
are evaluated and affect the script code that follows.</li>
<li>The variable that is used the <code class="docutils literal notranslate"><span class="pre">catch{...}</span></code> section to store the
error message becomes available to the script code that follows.</li>
</ol>
<p>The following example code excerpt clarifies the above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># it is assumed that the (missing) code may result in a being either 1 or 0</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">/</span> <span class="n">a</span>  <span class="c1"># if a == 0 this will lead to an error</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">12</span>
<span class="p">}</span>
<span class="n">catch</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NOP</span>
<span class="p">}</span>
<span class="o">...</span><span class="n">code</span> <span class="n">that</span> <span class="n">follows</span><span class="o">...</span>
</pre></div>
</div>
<p>Now, if <code class="docutils literal notranslate"><span class="pre">a</span></code> is <em>not</em> zero at the point the <code class="docutils literal notranslate"><span class="pre">try...catch</span></code> block is
evaluated, then three new local variables in the current scope will be
created (<code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">z</span></code>) and be available for use by the code that
follows.</p>
<p>If however, <code class="docutils literal notranslate"><span class="pre">a</span></code> <em>is</em> zero, then from the three variables in the try section
only <code class="docutils literal notranslate"><span class="pre">y</span></code> will be created; in addition, since the catch section will be
evaluated, <code class="docutils literal notranslate"><span class="pre">msg</span></code> will be created. Thus the variables available for use by
the code that follows will be <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">msg</span></code>.</p>
<hr class="docutils" />
<p>Back to the <a class="reference internal" href="script_ref_execution_model.html"><span class="doc">script execution model</span></a>.</p>
<p>$Date: 2011/04/29 20:11:14 $</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="script_ref_execution_model_perf_cons.html" title="The script execution model - Performance considerations"
             >next</a> |</li>
        <li class="right" >
          <a href="script_ref_execution_model_filter_graph.html" title="The script execution model - The filter graph"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2000-2019, AviSynth and AviSynth+ contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>