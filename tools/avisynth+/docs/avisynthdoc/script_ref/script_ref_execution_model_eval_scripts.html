

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>The script execution model - Evaluation of runtime scripts &#8212; AviSynth+ 3.4 documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../_static/AvsiDoc.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="The script execution model - The fetching of frames" href="script_ref_execution_model_fetching_frames.html" />
    <link rel="prev" title="The script execution model" href="script_ref_execution_model.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="script_ref_execution_model_fetching_frames.html" title="The script execution model - The fetching of frames"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="script_ref_execution_model.html" title="The script execution model"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/DocIcon-Large.svg" alt="Logo"/>
            </a></p>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The script execution model - Evaluation of runtime scripts</a><ul>
<li><a class="reference internal" href="#runtime-environment-initialisation">Runtime environment initialisation</a></li>
<li><a class="reference internal" href="#runtime-script-parsing-and-evaluation">Runtime script parsing and evaluation</a></li>
<li><a class="reference internal" href="#runtime-environment-cleanup-and-delivery-of-the-resulting-frame">Runtime environment cleanup and delivery of the resulting frame</a></li>
<li><a class="reference internal" href="#the-runtime-environment-in-detail">The runtime environment in detail</a><ul>
<li><a class="reference internal" href="#elements-of-the-runtime-environment">Elements of the runtime environment</a></li>
<li><a class="reference internal" href="#runtime-functions-and-current-frame">Runtime functions and current_frame</a></li>
<li><a class="reference internal" href="#checklist-for-developing-correct-runtime-scripts">Checklist for developing correct runtime scripts</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="script_ref_execution_model.html"
                        title="previous chapter">The script execution model</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="script_ref_execution_model_fetching_frames.html"
                        title="next chapter">The script execution model - The fetching of frames</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/avisynthdoc/script_ref/script_ref_execution_model_eval_scripts.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-script-execution-model-evaluation-of-runtime-scripts">
<h1><a class="toc-backref" href="#id1">The script execution model - Evaluation of runtime scripts</a><a class="headerlink" href="#the-script-execution-model-evaluation-of-runtime-scripts" title="Permalink to this headline">¶</a></h1>
<p>Evaluation of runtime scripts starts, as already stated, at the frame serving
phase of the main script’s execution. At that point frames of the final
output clip are requested by the host video application. This triggers a
sequence of successive calls to the GetFrame / GetAudio methods of all
filters along the filter graph. Whenever one of those filters is a runtime
filter, the following three-phase sequence of events happens <em>in every
frame</em>:</p>
<ul class="simple">
<li>Runtime environment initialisation.</li>
<li>Runtime script parsing and evaluation.</li>
<li>Runtime environment cleanup and delivery of the resulting frame.</li>
</ul>
<p>The following paragraphs examine each phase in more detail.</p>
<div class="toctree-wrapper compound">
</div>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#the-script-execution-model-evaluation-of-runtime-scripts" id="id1">The script execution model - Evaluation of runtime scripts</a><ul>
<li><a class="reference internal" href="#runtime-environment-initialisation" id="id2">Runtime environment initialisation</a></li>
<li><a class="reference internal" href="#runtime-script-parsing-and-evaluation" id="id3">Runtime script parsing and evaluation</a></li>
<li><a class="reference internal" href="#runtime-environment-cleanup-and-delivery-of-the-resulting-frame" id="id4">Runtime environment cleanup and delivery of the resulting frame</a></li>
<li><a class="reference internal" href="#the-runtime-environment-in-detail" id="id5">The runtime environment in detail</a><ul>
<li><a class="reference internal" href="#elements-of-the-runtime-environment" id="id6">Elements of the runtime environment</a></li>
<li><a class="reference internal" href="#runtime-functions-and-current-frame" id="id7">Runtime functions and current_frame</a></li>
<li><a class="reference internal" href="#checklist-for-developing-correct-runtime-scripts" id="id8">Checklist for developing correct runtime scripts</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="runtime-environment-initialisation">
<h2><a class="toc-backref" href="#id2">Runtime environment initialisation</a><a class="headerlink" href="#runtime-environment-initialisation" title="Permalink to this headline">¶</a></h2>
<p>The runtime filter code sets (at the top-level script local scope) its
<a class="reference internal" href="../syntax/syntax_runtime_environment.html"><span class="doc">special variables</span></a> for the runtime script. These at the minimum include
<code class="docutils literal notranslate"><span class="pre">last</span></code>, which is set to the filter’s source clip and <code class="docutils literal notranslate"><span class="pre">current_frame</span></code>,
which is set to the frame number requested by the filter from the AviSynth
code.</p>
<p>As a consequence, those special variables <em>cannot</em> be passed between runtime
scripts; whatever value the passing script will set, it will be overwritten
by the receiving filter’s frame initialisation code.</p>
</div>
<div class="section" id="runtime-script-parsing-and-evaluation">
<h2><a class="toc-backref" href="#id3">Runtime script parsing and evaluation</a><a class="headerlink" href="#runtime-script-parsing-and-evaluation" title="Permalink to this headline">¶</a></h2>
<p>The runtime script is parsed, as a regular script would be parsed if loaded
in AviSynth. The parsing mechanism is the same. Thus <em>everything</em> allowed to
a regular script is allowed to a runtime script; <em>what changes is the context
of execution</em>. For example, you can:</p>
<ul class="simple">
<li>Use <strong>multi-line scripts</strong>; they just have to be contained inside a
three-double-quotes pair (this is a requirement only if string literals
are used inside the script, else single double quotes can be used also).</li>
<li>Define / assign variables, both local and global.</li>
<li><a class="reference internal" href="../corefilters/import.html"><span class="doc">Import</span></a> other scripts and/or load plugins and/or define functions.</li>
<li>Call functions and filters.</li>
<li>Use <a class="reference internal" href="script_ref_arrays.html"><span class="doc">arrays</span></a> and <a class="reference internal" href="script_ref_block_statements.html"><span class="doc">block statements</span></a>.</li>
<li>Use <a class="reference internal" href="../syntax/syntax_control_structures.html"><span class="doc">control structures</span></a>.</li>
</ul>
<p>Of course, some of the above are <strong>not advisable</strong>, because the different
execution context poses different constrains regarding performance and
resource usage. The main rule of thumb here is: <strong>Parsing occurs in every
frame requested. Therefore, computationally expensive actions should be
avoided</strong>. More on the <a class="reference internal" href="script_ref_execution_model.html"><span class="doc">performance considerations</span></a> section.</p>
</div>
<div class="section" id="runtime-environment-cleanup-and-delivery-of-the-resulting-frame">
<h2><a class="toc-backref" href="#id4">Runtime environment cleanup and delivery of the resulting frame</a><a class="headerlink" href="#runtime-environment-cleanup-and-delivery-of-the-resulting-frame" title="Permalink to this headline">¶</a></h2>
<p>The runtime filter code receives the result of script parsing and evaluation.
If all went well, the result will be a valid filter graph (the runtime filter
graph) from which the runtime filter requests to fetch the needed frame. If
not, the filter will propagate the error to the caller. When the filter’s
code will return the final video frame, the runtime filter graph will be
destroyed. As part of the cleanup the runtime filter code also restores the
<code class="docutils literal notranslate"><span class="pre">last</span></code> special variable to its previous value.</p>
</div>
<div class="section" id="the-runtime-environment-in-detail">
<h2><a class="toc-backref" href="#id5">The runtime environment in detail</a><a class="headerlink" href="#the-runtime-environment-in-detail" title="Permalink to this headline">¶</a></h2>
<p>Despite the very thin layer of added features (just a handful of variables
and functions) the runtime environment is much more dynamic that the normal
(main) script environment. The <em>key-difference</em> is the event-driven model of
runtime script execution as opposed to the linear flow of the main script’s
execution. Execution of a runtime script occurs only in the event of a frame
request. In addition, since intermediate filters in the chain may shuffle and
combine frames in an arbitrary fashion, the requested frame’s number may be
different than the final clip’s frame number.</p>
<div class="section" id="elements-of-the-runtime-environment">
<h3><a class="toc-backref" href="#id6">Elements of the runtime environment</a><a class="headerlink" href="#elements-of-the-runtime-environment" title="Permalink to this headline">¶</a></h3>
<p>At any time during the frame serving phase, the elements of the runtime
environment are the following:</p>
<ul class="simple">
<li>The environment inherited by the main script’s parsing phase, that is
the main script’s top-level local variables, the global variables and all
imported script and plugin functions.</li>
<li>The <a class="reference internal" href="../syntax/syntax_runtime_environment.html"><span class="doc">special variables</span></a> set on every frame by the runtime filter
initialisation code (<code class="docutils literal notranslate"><span class="pre">last</span></code>, <code class="docutils literal notranslate"><span class="pre">current_frame</span></code>, etc.)</li>
<li>A set of <a class="reference internal" href="../syntax/syntax_internal_functions_runtime.html"><span class="doc">runtime functions</span></a> to assist common information extraction
operations.</li>
<li>The environment created by the successive evaluation of runtime
scripts triggered by all the final output clip’s frames that have been
requested so far by the host video application. This may include
modifications to the environment inherited by the parsing phase such as
change of variables’ values, as well as addition of new locals and
globals.</li>
</ul>
</div>
<div class="section" id="runtime-functions-and-current-frame">
<h3><a class="toc-backref" href="#id7">Runtime functions and current_frame</a><a class="headerlink" href="#runtime-functions-and-current-frame" title="Permalink to this headline">¶</a></h3>
<p>An interesting feature of <a class="reference internal" href="../syntax/syntax_internal_functions_runtime.html"><span class="doc">runtime functions</span></a> is that they consult the value
of the <code class="docutils literal notranslate"><span class="pre">current_frame</span></code> special variable in order to determine what frame of
their input clip(s) to inspect for extracting information. This provides the
ability inside a runtime script to easily request information for <em>any</em> frame
of a clip by changing before the call to the function the <code class="docutils literal notranslate"><span class="pre">current_frame</span></code>
variable.</p>
<p>As explained above, setting the <code class="docutils literal notranslate"><span class="pre">current_frame</span></code> variable has no effect on
other runtime scripts in the filter chain because the runtime filters’
initialisation code resets <code class="docutils literal notranslate"><span class="pre">current_frame</span></code> to the proper value before
executing the runtime script. It also has no effect on subsequent filter
calls in the runtime script. But it does have on runtime functions and
anywhere the value of <code class="docutils literal notranslate"><span class="pre">current_frame</span></code> is used. Therefore, after such a
usage it is good practice to restore the variable to its initial value before
issuing other script commands.</p>
<p>A skeleton example of a runtime script that computes a weighted second order
luma interpolation value (the actions after the computation are omitted)
follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span><span class="n">previous</span> <span class="n">processing</span> <span class="n">omitted</span><span class="o">...</span>
<span class="n">ScriptClip</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;  # this is a multiline string</span>
<span class="s2">    n = current_frame</span>
<span class="s2">    lm_k = AverageLuma()</span>
<span class="s2">    current_frame = n - 1</span>
<span class="s2">    lm_km1 = AverageLuma()</span>
<span class="s2">    current_frame = n + 1</span>
<span class="s2">    lm_kp1 = AverageLuma()</span>
<span class="s2">    dvg = (lm_km1 - 2 * lm_k + lm_kp1) / 2</span>
<span class="s2">    lm_ipl = lm_k + Sign(dvg) * Sqrt(Abs(dvg))</span>
<span class="s2">    current_frame = n # remember to reset current_frame</span>
<span class="s2">    ...rest of script omitted...</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
<span class="o">...</span><span class="n">subsequent</span> <span class="n">processing</span> <span class="n">omitted</span><span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="checklist-for-developing-correct-runtime-scripts">
<h3><a class="toc-backref" href="#id8">Checklist for developing correct runtime scripts</a><a class="headerlink" href="#checklist-for-developing-correct-runtime-scripts" title="Permalink to this headline">¶</a></h3>
<p>Despite the dynamic nature of the runtime environment, creating runtime
scripts is relatively easy if you follow a simple set of rules:</p>
<ul class="simple">
<li>Remember that your input (source) clip is stored upon start of script
execution in the <code class="docutils literal notranslate"><span class="pre">last</span></code> special variable.</li>
<li>If you assign temporary clips to variables, remember to set <code class="docutils literal notranslate"><span class="pre">last</span></code>
at the end or issue a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement.</li>
<li>Do not change (with respect to the source clip of the filter) the
dimensions, colorspace or framerate of the final result.</li>
<li>Do not assume - unless there is a <strong>very</strong> compelling performance-
related reason- a particular ordering of frame requests; try to build
ordering-neutral scripts, that depend only on <code class="docutils literal notranslate"><span class="pre">current_frame</span></code>.</li>
<li>Inspect the names of all input variables (ie those variables that are
<em>not initialised</em> to a value inside the runtime script) of your runtime
scripts to ensure that they are not overridden accidentally by a normal,
not used for inter-script communication variable in any runtime script
along the chain.</li>
<li>In particular, avoid putting inside <a class="reference internal" href="../syntax/syntax_userdefined_scriptfunctions.html"><span class="doc">functions</span></a> calls to runtime
filters that share state between invocations or with other filters
through variables; it is easy to forget that <em>you may only call the
function once</em>, else you will end up with multiple filters that share
<em>the same</em> variables, thus with a bug in your script.</li>
</ul>
<p>In view of the above, runtime filters should be used in functions only if
they either:</p>
<ul class="simple">
<li>do not share state between invocations or with other filters through
variables, or</li>
<li>the function code takes care to create <em>unique names</em> of all the
runtime script’s shared variables on each function invocation.</li>
</ul>
<p>A way to avoid variables is to dynamically build the runtime script using
string concatenation and assign the related arguments’ values to local
variables in the runtime script. See the example code of the <a class="reference internal" href="script_ref_execution_model_lifetime_variables.html"><span class="doc">bracket_luma</span></a>
function.</p>
<hr class="docutils" />
<p>Back to the <a class="reference internal" href="script_ref_execution_model.html"><span class="doc">script execution model</span></a>.</p>
<p>$Date: 2011/04/29 20:11:14 $</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="script_ref_execution_model_fetching_frames.html" title="The script execution model - The fetching of frames"
             >next</a> |</li>
        <li class="right" >
          <a href="script_ref_execution_model.html" title="The script execution model"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AviSynth+ 3.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Invisible Tree</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2000-2019, AviSynth and AviSynth+ contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>